<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .container {
            display: flex;
            margin-left: auto;
            margin-right: auto;
            width: 1200px;
            background-color: #f0f0f0;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Add shadow */
            height: 1000px; /* Increase the height as needed */
            overflow: hidden; /* Prevent content from overflowing */
            position: relative; /* Ensure positioned children are contained */
        }

        /* CSS cho sidebar */
        .sidebar {
            width: auto; /* Chiều rộng tự động dựa trên nội dung */
            min-width: 200px; /* Chiều rộng tối thiểu */
            max-width: 300px; /* Chiều rộng tối đa */
            overflow: auto; /* Thêm cuộn nếu nội dung vượt quá chiều rộng tối đa */
            background-color: #f9f9f9; /* Màu nền cho sidebar */
            border: 1px solid #ddd; /* Viền cho sidebar */
            padding: 10px; /* Khoảng cách bên trong */
            box-sizing: border-box; /* Bao gồm cả padding và border trong chiều rộng và chiều cao */
        }


        .user-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
        }

        .edit-profile {
            font-size: 12px;
            color: #007bff;
            cursor: pointer;
        }

        .sidebar a {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: #333;
            margin-bottom: 5px;
        }

        .sidebar a:hover {
            background-color: #ff5722;
            color: #fff;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 20px;
            background-color: #fff;
            height: 100%; /* Ensure it takes full height of the parent */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: auto; /* Add scroll if content overflows */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group input[type="radio"] {
            width: auto;
        }

        .form-group .radio-group {
            display: flex;
            gap: 10px;
        }

        .form-group .radio-group label {
            display: inline;
        }

        .form-group button {
            padding: 10px 20px;
            background-color: #ff5722;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .form-group button:hover {
            background-color: #e64a19;
        }

        .form-group .dob-group {
            display: flex;
            gap: 10px;
        }

        .form-group .dob-group select {
            width: auto;
            flex-grow: 1;
        }

        .tabs {
            display: none;
        }

        .tabs.active {
            display: block;
        }

        .tabs ul {
            list-style-type: none;
            padding: 0;
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .tabs ul li {
            flex-grow: 1;
        }

        .tabs ul li a {
            text-decoration: none;
            padding: 15px;
            background-color: #f5f5f5;
            color: #333;
            display: block;
            text-align: center;
            border-radius: 5px;
            font-size: 16px;
        }

        .tabs ul li a:hover, .tabs ul li a.active {
            background-color: #ff5722;
            color: #fff;
        }

        .separator {
            height: 1px;
            background-color: #ccc;
            margin: 20px 0;
        }

        .profile-form-container {
            display: flex;
            justify-content: space-between;
            height: calc(100% - 100px);
        }

        .profile-form-container .form-section, .profile-form-container .profile-pic-section {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .profile-form-container .form-section {
            margin-right: 20px;
        }

        .profile-pic-section {
            text-align: center;
        }

        #change-password-button {
            display: block;
            margin: 20px auto 0 auto; /* 20px from the top, auto for left and right margins to center the button */
            padding: 10px 20px;
            background-color: #ff5722;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
        }

        #change-password-button:hover {
            background-color: #e64a19;
        }

        .profile-pic-section img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .sub-menu a:hover {
            background-color: #ff5722;
            color: #fff;
            font-size: 14px;
        }

        .sub-menu a {
            display: block;
            padding-left: 40px; /* Dịch chữ bên trong sang phải 20px */
            text-decoration: none;
            color: inherit;
        }


        .sidebar a.active, .sidebar a:hover {
            background-color: #ff5722;
            color: #fff;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            text-align: center;
            display: none;
            width: 200px;
        }

        .tabs {
            display: none;
        }

        .tabs.active {
            display: block;
        }

        .profile-form-container .form-section,
        .profile-form-container .profile-pic-section {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .address-list {
            margin-top: 20px;
        }

        .address-item h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: normal;
        }

        .address-item p {
            margin: 0;
        }

        .address-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .address-item .default {
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #ff5722;
            border-radius: 4px;
            color: #ff5722;
            margin-left: 10px;
        }

        .address-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .address-info {
            flex-grow: 1;
        }

        .address-actions {
            display: flex;
            gap: 10px; /* Hiển thị các nút bên cạnh nhau */
            align-items: center;
        }

        button.edit-address-btn,
        button.delete-address-btn,
        button.default-address-btn {
            background-color: #fff; /* Khung không màu cam */
            color: #ff5722;
            border: 2px solid #ff5722;
            padding: 10px 20px;
            border-radius: 4px; /* Bo góc */
            cursor: pointer;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 20px;
            background-color: #fff;
            height: 100%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }

        .order-contents {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            width: 996px;
            height: 880px;
            box-sizing: border-box;
            position: relative;
        }

        .order-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }



        .order-item {
            background-color: #f0f0f0; /* Màu xám nhạt */
            border-radius: 8px; /* Bo góc */
            padding: 15px; /* Khoảng cách bên trong */
            margin-bottom: 10px; /* Khoảng cách giữa các ô */
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ */
            word-wrap: break-word; /* Ngắt từ khi quá dài */
            width: 100%; /* Chiều rộng đầy đủ */
            box-sizing: border-box; /* Bao gồm cả padding và border */
        }

        .order-item h3 {
            margin: 0; /* Loại bỏ khoảng cách mặc định của h4 và p */
            padding-bottom: 10px; /* Khoảng cách dưới mỗi đoạn */
            font-size: 18px; /* Tăng cỡ chữ */
            font-weight: normal; /* Không đậm chữ */
        }

        .order-item p {
            margin: 0; /* Loại bỏ khoảng cách mặc định của h4 và p */
            padding-bottom: 10px; /* Khoảng cách dưới mỗi đoạn */
        }

        .order-item .status {
            float: right; /* Dịch sang góc phải */
            color: red; /* Màu đỏ */
        }

        .order-item .classification {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item .total {
            text-align: right; /* Dịch sang góc phải */
            color: red; /* Màu đỏ */
            margin-top: 10px; /* Khoảng cách trên */
            font-size: 18px;
        }

        .order-item .actions {
            margin-top: 15px; /* Khoảng cách trên cùng */
            display: flex;
            justify-content: space-between; /* Đặt các nút cách đều nhau */
        }

        .order-item .actions button {
            padding: 10px 20px; /* Khoảng cách bên trong nút */
            border: none; /* Bỏ viền */
            border-radius: 4px; /* Bo góc */
            cursor: pointer; /* Con trỏ chuột */
        }

        .order-item .actions .buy-again {
            background-color: #ff5722; /* Màu cam cho nút Mua lại */
            color: #fff; /* Màu chữ trắng */
        }

        .order-item .actions .cancel-details {
            background-color: #cccccc;
            color: #333; /* Màu chữ đen đậm */
        }

        .tab-link {
            text-decoration: none;
            color: #333; /* Default color */
            padding: 10px 20px;
            display: inline-block;
        }

        .tab-link.active {
            background-color: #ff5722; /* Màu cam cho tab đang chọn */
            color: #fff; /* Màu chữ trắng */
            border-radius: 4px; /* Bo góc */
        }

        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-radius: 8px;
            text-align: center;
            width: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .confirm-dialog button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #confirm-yes {
            background-color: #ff5722;
            color: #fff;
        }

        #confirm-no {
            background-color: #f0f0f0;
            color: #333;
        }

        /* CSS cho form thêm mới địa chỉ */
        #add-address-form {
            background-color: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            width: 50%;
            margin: 20px auto;
        }

        #add-address-form h3 {
            margin-bottom: 20px;
        }

        #add-address-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #add-address-form input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #add-address-form .error-message {
            color: red;
            margin-top: -10px;
            margin-bottom: 10px;
            font-size: 0.875em;
        }

        #add-address-form button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        #add-address-form button:first-of-type {
            background-color: #ff5722;
            color: #fff;
        }

        #add-address-form button:last-of-type {
            background-color: #f0f0f0;
            color: #333;
        }

        .refund {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .refund-label {
            color: black;
            margin-right: 5px;
        }

        .refund-amount {
            color: red;
            font-size: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-name {
            font-size: 20px;
        }


        #orders-link {
            display: flex;
            align-items: center;

            #account-link, #orders-link {
                font-size: 16px; /* Đặt cỡ chữ */
            }

            font-size: 16px; /* Đặt cỡ chữ */
            text-decoration: none;
            color: inherit;
        }

        #orders-link .link-icon {
            width: 20px;
            height: 18px;
            margin-right: 8px; /* Khoảng cách giữa hình ảnh và văn bản */
        }

        #account-link {
            display: flex;
            align-items: center;
            font-size: 16px; /* Đặt cỡ chữ */
            text-decoration: none;
            color: inherit;
        }

        #account-link .link-icon {
            width: 20px;
            height: 18px;
            margin-right: 8px; /* Khoảng cách giữa hình ảnh và văn bản */
        }

        /* General order container */
        /*.order-container {*/
        /*    background-color: #fff;*/
        /*    border-radius: 8px;*/
        /*    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);*/
        /*    margin-bottom: 20px;*/
        /*    padding: 20px;*/
        /*}*/

        /* Header of the order */
        .order-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .order-header h2 {
            font-size: 1.2em;
            margin: 0;
            color: #333;
        }

        .order-header .status {
            font-weight: bold;
            color: #ff5722;
        }

        /* Order items */
        .order-details {
            margin-bottom: 15px;
        }

        .order-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item h3 {
            font-size: 1.1em;
            margin: 0 0 10px;
        }

        .classification p {
            margin: 5px 0;
        }

        .price {
            font-weight: bold;
            color: #ff5722;
        }

        .total {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }

        /* Total amount section (below order details) */
        .order-total {
            font-size: 24px; /* Set font size to 24px */
            font-weight: bold;
            color: #f44336; /* Set color to red */
            margin-top: 20px; /* Create space before the total */
            text-align: right; /* Align the total amount to the right */
        }

        .order-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px; /* Add some space between buttons */
        }

        .order-actions button,
        .order-actions .cancel-order {
            background-color: #4caf50;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 1em;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .order-actions button:hover {
            background-color: #45a049;
        }

        .order-actions .cancel-order {
            background-color: #ff5722;
        }

        .order-actions .cancel-order:hover {
            background-color: #e64a19;
        }

        /* Refund message */
        .refund {
            margin-top: 10px;
            font-size: 1.1em;
            color: #333;
        }

        .refund-label {
            font-weight: bold;
        }

        .refund-amount {
            color: #ff5722;
        }

        /* Style cho modal confirm cancel */
        #confirm-cancel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        /* Overlay background (hiển thị mờ phía sau modal) */
        #confirm-cancel::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: -1;
        }

        /* Style cho phần tiêu đề của modal */
        #confirm-cancel-message {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        /* Style cho phần lựa chọn lý do hủy */
        #cancel-reason-container {
            text-align: left;
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* Style cho mỗi label chứa radio button */
        #cancel-reason-container label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
            padding-left: 25px;
            position: relative;
        }

        /* Style cho các radio button */
        #cancel-reason-container input[type="radio"] {
            position: absolute;
            left: 0;
            top: 0;
            margin-top: 5px;
        }

        /* Style cho các nút xác nhận và hủy */
        #confirm-cancel-yes, #confirm-cancel-no {
            padding: 10px 20px;
            margin-top: 10px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* Style cho nút xác nhận */
        #confirm-cancel-yes {
            background-color: #4CAF50;
            color: white;
        }

        #confirm-cancel-yes:hover {
            background-color: #45a049;
        }

        /* Style cho nút hủy */
        #confirm-cancel-no {
            background-color: #f44336;
            color: white;
        }

        #confirm-cancel-no:hover {
            background-color: #e53935;
        }

        /* Đảm bảo modal không bị tràn ra ngoài khi có nội dung dài */
        #confirm-cancel button {
            font-size: 16px;
            padding: 10px 20px;
            margin-top: 20px;
        }

        /* Thiết lập responsive cho modal */
        @media (max-width: 600px) {
            #confirm-cancel {
                width: 90%;
            }
        }

        /* General modal styles */
        .cancel-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Transparent background */
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .-detail-modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-out; /* Animation for fade-in effect */
        }

        /* Title styling */
        .-detail-modal-content h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        /* Product detail styling */
        .product-detail {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
        }

        .product-detail h4 {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }

        .product-detail p {
            font-size: 1rem;
            color: #777;
            margin: 5px 0;
        }

        /* Close button styling */
        #close-detail-cancel-modal {
            background-color: #ff5733; /* Red color for close button */
            color: white;
            font-size: 1rem;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        #close-detail-cancel-modal:hover {
            background-color: #e14a2b; /* Darker red on hover */
        }

        /* Animation for modal fade-in */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Nội dung modal */
        .-detail-modal-content {
            background-color: white;
            width: 60%;
            max-width: 800px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -150px;
            margin-left: -400px;
        }


        /* Nội dung modal */
        .-detail-modal-content {
            background-color: white;
            width: 60%;
            max-width: 800px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 30%;
            left: 50%;
            margin-left: -400px;
        }


        /* Tiêu đề modal */
        .-detail-modal-content h3 {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        /* Chi tiết sản phẩm */
        .product-detail {
            display: flex;
            margin-bottom: 15px;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .product-detail img {
            max-width: 100px;
            height: auto;
            border-radius: 5px;
        }

        .product-info {
            flex-grow: 1;
            margin-left: 20px;
            text-align: left;
        }

        .product-info h4 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .product-info p {
            margin: 5px 0;
            color: #555;
        }

        .price {
            font-weight: bold;
            color: #e74c3c;
        }

        /* Lý do hủy đơn */
        #cancel-reason {
            margin-top: 20px;
            text-align: left;
        }

        #cancel-reason h5 {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #cancel-reason p {
            font-size: 16px;
            color: #555;
        }

        /* Nút đóng modal */
        #close-detail-cancel-modal {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #close-detail-cancel-modal:hover {
            background-color: #2980b9;
        }

        /* Khi modal hiển thị */
        .cancel-detail-modal.show {
            display: flex;
        }

        /* Mã đơn hàng */
        #order-code {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        #order-code h3 {
            color: #e74c3c;
            font-size: 24px;
            font-weight: bold;
        }

        /* Khung bao quanh toàn bộ danh sách voucher */
        #voucher-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
            background-color: #f4f4f4;
        }

        /* Mỗi ô voucher */
        .voucher-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            width: 250px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Hiệu ứng hover khi người dùng di chuột vào ô voucher */
        .voucher-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Tiêu đề voucher (mã voucher) */
        .voucher-item h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        /* Mô tả voucher */
        .voucher-item p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        /* Giá trị voucher (màu đỏ nổi bật) */
        .voucher-item p:last-child {
            font-size: 16px;
            font-weight: bold;
            color: red;
        }

        /* Định dạng ngày hết hạn */
        .voucher-item p:last-child {
            font-size: 16px;
            font-weight: bold;
            color: #888;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            overflow: auto;
            padding-top: 60px;
            opacity: 0;
            transition: opacity 0.4s ease, visibility 0s linear 0.4s;
        }

        /* Nội dung modal */
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        /* Khi modal mở */
        .modal.show {
            display: block;
            opacity: 1;
            visibility: visible;
        }

        /* Khi modal-content mở */
        .modal.show .modal-content {
            opacity: 1;
            transform: scale(1);
        }

        /* Tiêu đề modal */
        h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }

        /* Form các trường trong modal */
        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
            color: #333;
        }

        /* Style cho textarea */
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
        }

        textarea:focus {
            border-color: #4CAF50;
        }

        /* Style cho dropdown (select) */
        select {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
        }

        select:focus {
            border-color: #4CAF50;
        }

        /* Phần danh sách sản phẩm */
        .product-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto; /* Nếu danh sách dài hơn, sẽ cuộn dọc */
        }

        /*!* Mỗi sản phẩm trong danh sách *!*/
        /*.product-item {*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    margin-bottom: 15px;*/
        /*    padding: 15px;*/
        /*    border: 1px solid #ddd;*/
        /*    border-radius: 8px;*/
        /*    background-color: #f9f9f9;*/
        /*    transition: background-color 0.3s ease;*/
        /*    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);*/
        /*}*/

        /* Hover effect */
        .product-item:hover {
            background-color: #f0f0f0;
        }

        /* Căn chỉnh ảnh sản phẩm */
        .product-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 4px;
        }

        /* Thông tin sản phẩm */
        .product-item label {
            flex-grow: 1;
            margin: 0;
            font-size: 16px;
        }

        /* Hiển thị số lượng và giá sản phẩm */
        .product-item span {
            font-weight: bold;
            color: #4CAF50;
            font-size: 14px;
        }

        /* Nút đóng modal */
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute; /* Đặt nút ở vị trí tuyệt đối */
            top: 15px; /* Cách từ trên cùng 15px */
            right: 15px; /* Cách từ bên phải 15px */
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }


        /* Nút Gửi yêu cầu */
        .submit-request-btn {
            background-color: #4CAF50; /* Màu nền xanh lá */
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%; /* Chiếm toàn bộ chiều rộng của modal */
            transition: background-color 0.3s ease;
        }

        /* Hiệu ứng hover cho nút Gửi yêu cầu */
        .submit-request-btn:hover {
            background-color: #45a049; /* Màu xanh lá đậm hơn khi hover */
        }

        /* Hiệu ứng khi nút bị vô hiệu hóa */
        .submit-request-btn:disabled {
            background-color: #ccc; /* Màu xám khi nút không thể nhấn */
            cursor: not-allowed; /* Hiển thị con trỏ chuột không thể nhấn */
        }

        /* Số lượng sản phẩm */
        .product-item span {
            font-size: 14px;
            color: #333;
            margin-left: 10px;
            font-weight: normal;
            display: inline-block;
            text-align: right;
        }

        /*!* Đảm bảo chiều rộng ô sản phẩm phù hợp *!*/
        /*.product-item {*/
        /*    flex: 1 1 calc(33.333% - 20px); !* Mỗi ô chiếm 1/3 chiều rộng *!*/
        /*    max-width: calc(33.333% - 20px); !* Cố định chiều rộng tối đa *!*/
        /*    margin: 10px; !* Khoảng cách giữa các ô *!*/
        /*}*/

        /*@media (max-width: 768px) {*/
        /*    .product-item {*/
        /*        flex: 1 1 100%; !* Đảm bảo các ô sản phẩm chiếm toàn bộ chiều rộng trên màn hình nhỏ *!*/
        /*    }*/
        /*}*/

        /* Khu vực chứa preview tệp */
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        /* Mỗi phần tử preview */
        .preview-item {
            position: relative; /* Cần thiết để định vị dấu "X" trong phần tử */
            width: 150px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f9f9f9;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Hiệu ứng hover khi rê chuột vào phần tử */
        .preview-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Hình ảnh trong preview */
        .preview-item img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            object-fit: cover; /* Đảm bảo hình ảnh không bị méo và lấp đầy khu vực */
        }

        /* Tên tệp */
        .preview-item p {
            margin-top: 10px;
            font-size: 14px;
            color: #333;
            word-wrap: break-word; /* Đảm bảo tên tệp không bị tràn ra ngoài */
        }

        /* Video */
        .preview-item video {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        /* Thêm border cho video khi hover */
        .preview-item video:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Nút xóa dấu X */
        .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7); /* Màu nền đỏ */
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10; /* Đảm bảo dấu X luôn nằm trên ảnh */
        }

        /* Hiệu ứng hover khi rê chuột vào dấu X */
        .close-btn:hover {
            background-color: red;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control button {
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .quantity-control input {
            width: 40px;
            text-align: center;
        }
        .product-container {
            display: flex;
            flex-direction: column; /* Đặt các sản phẩm theo cột */
            gap: 15px; /* Khoảng cách giữa các sản phẩm */
        }

        .product-item {
            display: flex;
            justify-content: space-between; /* Phân chia không gian giữa các phần */
            width: 100%; /* Chiếm toàn bộ chiều ngang */
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-sizing: border-box; /* Đảm bảo padding không làm thay đổi chiều rộng */
            align-items: center; /* Căn giữa các phần tử bên trong */
        }

        .product-image img {
            width: 80px;
            height: auto;
            object-fit: cover;
            border-radius: 5px;
        }

        .product-info {
            flex-grow: 1;
            margin-left: 15px;
        }
        .avatar-container {
            position: relative;
            width: 50px;
            height: 50px;
        }
        .user-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 12px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            color: white;
            white-space: nowrap;
        }

        /* Huy hiệu Bạc */
        .badge-silver {
            background: linear-gradient(45deg, #dcdcdc, #c0c0c0); /* Gradient bạc sáng đến bạc đậm */
            color: #4f4f4f; /* Màu chữ xám đậm để tạo sự tương phản */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8); /* Bóng chữ sáng */
            border: 1px solid #a9a9a9; /* Viền bạc */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); /* Hiệu ứng đổ bóng */
        }

        /* Huy hiệu Vàng */
        .badge-gold {
            background: linear-gradient(45deg, #ffd700, #ffaf00); /* Gradient vàng sáng đến vàng đậm */
            color: #fff; /* Màu chữ trắng */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); /* Bóng chữ tối */
            border: 1px solid #b8860b; /* Viền vàng đậm */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); /* Hiệu ứng đổ bóng */
        }

        /* Huy hiệu Kim Cương */
        .badge-diamond {
            background: linear-gradient(45deg, #a1c4fd, #c2e9fb); /* Gradient xanh lấp lánh */
            color: #004085; /* Màu chữ xanh đậm */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.6); /* Bóng chữ sáng */
            border: 1px solid #87ceeb; /* Viền xanh nhạt */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); /* Hiệu ứng đổ bóng */
        }



    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="../css/headerAll.css">
    <script src="/js/headerJs.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <!-- Thêm SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Thêm Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>

    <!-- Thêm Toastr JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>


</head>
<body>
<div th:include="header-all::body"></div>
<main>
    <div class="container">
        <div class="sidebar">
            <div class="user-info">
                <div class="avatar-container">
                    <img src="" alt="" class="user-icon" id="user-avatar"/>
                    <span class="user-badge" id="user-badge"></span>
                </div>
                <div class="user-name" id="user-name">Username</div>
            </div>

            <a href="#" id="account-link">
                <img src="https://down-vn.img.susercontent.com/file/ba61750a46794d8847c3f463c5e71cc4" alt="Icon"
                     class="link-icon">
                Tài khoản của tôi
            </a>
            <div class="sub-menu" id="account-submenu" style="display:none;">
                <a href="#" id="profile-link">Hồ sơ</a>
                <a href="#" id="change-password-link">Đổi mật khẩu</a>
                <a href="#" id="address-link">Địa chỉ</a>
                <a href="#" id="voucher-link">Voucher</a>
            </div>
            <a href="#" id="orders-link">
                <img src="https://down-vn.img.susercontent.com/file/f0049e9df4e536bc3e7f140d071e9078" alt="Icon"
                     class="link-icon">
                Đơn mua
            </a>

        </div>
        <div class="content">
            <div id="profile-form" class="tabs active">
                <h2>Hồ sơ của tôi</h2>
                <p>Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                <div class="separator"></div>
                <div class="profile-form-container">
                    <div class="form-section">
                        <div class="form-group">
                            <label for="username">Tên đăng nhập</label>
                            <input type="text" id="username" name="username" readonly>
                        </div>
                        <div class="form-group">
                            <label for="name">Tên</label>
                            <input type="text" id="name" name="name">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="phone">Số điện thoại</label>
                            <input type="text" id="phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="cccd">CCCD</label>
                            <input type="text" id="cccd" name="cccd">
                        </div>
                        <div class="form-group">
                            <label>Giới tính</label>
                            <div class="radio-group">
                                <label><input type="radio" name="gender" value="NAM"> Nam</label>
                                <label><input type="radio" name="gender" value="NU"> Nữ</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dob">Ngày sinh</label>
                            <input type="date" id="dob" name="dob">
                        </div>
                    </div>
                    <div class="profile-pic-section">
                        <img id="profile-pic-img" src="" alt="Avatar user">
                        <div class="form-group">
                            <label for="profile-pic">Ảnh đại diện</label>
                            <input type="file" id="profile-pic" name="profile-pic">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" id="update-button">Cập Nhật</button>
                </div>
            </div>
            <div id="password-form" class="tabs">
                <h2>Đổi Mật Khẩu</h2>
                <p>Đổi mật khẩu tài khoản của bạn</p>
                <div class="separator"></div>
                <form class="profile-form-container">
                    <div class="form-section">
                        <div class="form-group">
                            <label for="old-password">Mật khẩu cũ</label>
                            <input type="password" id="old-password" name="old-password">
                        </div>
                        <div class="form-group">
                            <label for="new-password">Mật khẩu mới</label>
                            <input type="password" id="new-password" name="new-password">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Xác nhận mật khẩu</label>
                            <input type="password" id="confirm-password" name="confirm-password">
                        </div>
                        <button type="submit" id="change-password-button">Đổi Mật Khẩu</button>
                    </div>
                    <!--                    <div class="form-group">-->
                    <!--                        <button type="submit" id="change-password-button">Đổi Mật Khẩu</button>-->
                    <!--                    </div>-->
                </form>
            </div>
            <div id="address-form" class="tabs">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Địa chỉ của tôi</h2>
                    <button type="button" id="add-address-button"
                            style="background-color: #ff5722; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Thêm địa chỉ mới
                    </button>
                </div>
                <div class="separator"></div>
                <div id="address-list" class="address-list">
                    <!-- Danh sách địa chỉ sẽ được hiển thị tại đây -->
                </div>
                <div id="add-address-form" style="display: none;">
                    <h3 id="form-title">Thêm mới địa chỉ</h3>
                    <label for="hoTen">Họ và tên:</label>
                    <input type="text" id="hoTen" name="hoTen"><br><br>
                    <label for="diaChi">Địa chỉ:</label>
                    <input type="text" id="diaChi" name="diaChi"><br><br>
                    <label for="sdt">Số điện thoại:</label>
                    <input type="text" id="sdt" name="sdt"><br><br>
                    <label for="thanhPho">Thành phố:</label>
                    <input type="text" id="thanhPho" name="thanhPho"><br><br>
                    <label for="quocGia">Quốc gia:</label>
                    <input type="text" id="quocGia" name="quocGia"><br><br>
                    <button id="save-button" onclick="submitNewAddress()">Lưu</button>
                    <button onclick="cancelNewAddress()">Hủy</button>
                </div>
                <!--                <div id="confirm-dialog" class="confirm-dialog" style="display: none;">-->
                <!--                    <p id="confirm-message">Bạn có chắc chắn muốn thực hiện hành động này không?</p>-->
                <!--                    <button id="confirm-yes">Có</button>-->
                <!--                    <button id="confirm-no">Không</button>-->
                <!--                </div>-->
            </div>

            <div id="orders-tabs" class="tabs">
                <div class="tab-links">
                    <ul>
                        <li><a href="#" class="tab-link" data-status="null">Tất cả</a></li>
                        <li><a href="#" class="tab-link" data-status="0">Chờ xác nhận</a></li>
                        <li><a href="#" class="tab-link" data-status="1">Chờ thanh toán</a></li>
                        <li><a href="#" class="tab-link" data-status="2">Chờ giao hàng</a></li>
                        <li><a href="#" class="tab-link" data-status="3">Vận chuyển</a></li>
                        <li><a href="#" class="tab-link" data-status="4">Hoàn thành</a></li>
                        <li><a href="#" class="tab-link" data-status="5">Đã hủy</a></li>
                        <li><a href="#" class="tab-link" data-status="6">Trả hàng/Hoàn tiền</a></li>
                    </ul>
                </div>
                <div id="order-contents" class="order-contents">
                    <!-- Thông tin đơn hàng sẽ được hiển thị tại đây -->
                </div>
            </div>
            <div id="voucher" class="tabs">
                <h2>Danh sách voucher</h2>
                <div class="separator"></div>
                <div id="voucher-list" class="voucher-list"></div>
            </div>
        </div>
    </div>
</main>
<div id="notification" class="notification"></div>
<div id="confirm-dialog" class="confirm-dialog" style="display: none;">
    <p id="confirm-message">Bạn có chắc chắn muốn thực hiện hành động này không?</p>
    <button id="confirm-yes">Có</button>
    <button id="confirm-no">Không</button>
</div>
<div id="confirm-cancel" class="confirm-dialog" style="display: none;">
    <h2 id="confirm-cancel-message">Lý do huỷ:</h2>
    <div class="separator"></div>
    <div id="cancel-reason-container">
        <label>
            <input type="radio" name="cancel-reason" value="Tôi muốn cập nhật địa chỉ/sđt nhận hàng">
            Tôi muốn cập nhật địa chỉ/sđt nhận hàng
        </label><br>
        <label>
            <input type="radio" name="cancel-reason" value="Tôi muốn thêm, thay đổi mã giảm giá">
            Tôi muốn thêm, thay đổi mã giảm giá
        </label><br>
        <label>
            <input type="radio" name="cancel-reason"
                   value="Tôi muốn thay đổi sản phẩm( kích thước, màu sắc, số lượng...)">
            Tôi muốn thay đổi sản phẩm( kích thước, màu sắc, số lượng...)
        </label><br>
        <label>
            <input type="radio" name="cancel-reason" value="Thủ tục thanh toán rắc rối">
            Thủ tục thanh toán rắc rối
        </label><br>
        <label>
            <input type="radio" name="cancel-reason"
                   value="Tôi tìm thấy chỗ mua khác tốt hơn( rẻ hơn, uy tín, giao nhanh hơn ...)">
            Tôi tìm thấy chỗ mua khác tốt hơn( rẻ hơn, uy tín, giao nhanh hơn ...)
        </label><br>
        <label>
            <input type="radio" name="cancel-reason" value="Tôi không có nhu cầu mua nữa">
            Tôi không có nhu cầu mua nữa
        </label><br>
        <label>
            <input type="radio" name="cancel-reason" value="Tôi không tìm thấy lý do hủy phù hợp">
            Tôi không tìm thấy lý do hủy phù hợp
        </label>
    </div>

    <button id="confirm-cancel-yes">Xác nhận</button>
    <button id="confirm-cancel-no">Hủy</button>
</div>
<!-- Modal để hiển thị chi tiết hủy đơn -->
<div id="cancel-detail-modal" class="cancel-detail-modal" style="display: none;">
    <div class="-detail-modal-content">
        <h3>Chi tiết hủy đơn</h3>
        <div id="cancel-details-content"></div> <!-- Phần nội dung chi tiết sản phẩm sẽ được cập nhật ở đây -->
        <button id="close-detail-cancel-modal" onclick="closeCancelModal()">Đóng</button>
    </div>
</div>
<!-- Modal Yêu Cầu Đổi Trả -->
<div id="request-return-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeRequestReturnModal()">&times;</span>
        <h2>Yêu cầu đổi trả</h2>
        <form id="request-return-form">
            <!-- Loại yêu cầu -->
            <label for="product-list">Chọn sản phẩm:<span style="color: red;">*</span></label>
            <div id="product-list" class="product-list">
                <!-- Các sản phẩm sẽ được hiển thị ở đây -->
            </div>
            <br/>

            <label for="type">Loại yêu cầu: <span style="color: red;">*</span></label>
            <select id="type" name="type" required onchange="toggleFields()">
                <option value="DOI_HANG">Đổi hàng</option>
                <option value="TRA_HANG">Trả hàng</option>
            </select>
            <br/>

            <!-- Lý do yêu cầu -->
            <label for="reason">Lý do: <span style="color: red;">*</span></label>
            <textarea id="reason" name="reason" rows="4" required></textarea>
            <br/>

            <!-- Ghi chú thêm -->
            <label for="note">Ghi chú:</label>
            <textarea id="note" name="note" rows="4"></textarea>
            <br/>

            <!-- Thông tin mặt hàng muốn đổi (ẩn mặc định, chỉ hiển thị khi chọn Đổi hàng) -->
            <div id="product-exchange-info" style="display: none;">
                <label for="product-exchange">Thông tin mặt hàng muốn đổi: <span style="color: red;">*</span></label>
                <textarea id="product-exchange" name="product-exchange" rows="4" placeholder="Thông tin về mặt hàng muốn đổi" required></textarea>
                <br/>
            </div>

            <!-- Thông tin chuyển khoản (ẩn mặc định, chỉ hiển thị khi chọn Trả hàng) -->
            <div id="bank-info-section" style="display: none;">
                <label for="bank-info">Thông tin chuyển khoản: <span style="color: red;">*</span></label>
                <textarea id="bank-info" name="bank-info" rows="4" placeholder="Nhập thông tin chuyển khoản (tên tài khoản, số tài khoản, ngân hàng, v.v.)" required></textarea>
                <br/>
            </div>

            <!-- Thêm trường chọn tệp -->
            <label for="files">Chọn tệp (Hình ảnh hoặc Video):<span style="color: red;">*</span></label>
            <input type="file" id="files" name="files[]" accept="image/*,video/*" multiple>
            <div id="file-preview" class="file-preview">
                <!-- Preview sẽ hiển thị ở đây -->
            </div>
            <br/>
            <br/>

            <!-- Nút Gửi yêu cầu -->
            <button type="button" class="submit-request-btn" onclick="submitReturnRequest()">Gửi yêu cầu</button>

        </form>
    </div>
</div>

<div th:include="footer::body"></div>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
<script>
    let diaChiIdToHandle = null; // Biến lưu trữ ID địa chỉ cho hành động cần thực hiện
    let confirmAction = null; // Biến lưu trữ loại hành động cần xác nhận
    let isEditing = false;
    let orderId = null;

    // Hàm để lấy và giải mã token
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        } catch (error) {
            console.error('Lỗi khi giải mã token:', error);
            return null;
        }
    }

    // Hàm để cập nhật thông tin người dùng
    // function updateUserInfo() {
    //     const token = localStorage.getItem('token');
    //     const userInfo = parseJwt(token);
    //
    //     if (userInfo) {
    //         const userName = userInfo.fullName;
    //
    //         document.getElementById('user-name').innerText = userName;
    //     }
    // }

    // Gọi hàm updateUserInfo để cập nhật thông tin người dùng khi trang tải
    // document.addEventListener('DOMContentLoaded', updateUserInfo);

    document.getElementById('account-link').addEventListener('click', function () {
        var submenu = document.getElementById('account-submenu');
        if (submenu.style.display === 'none' || submenu.style.display === '') {
            submenu.style.display = 'block';
        } else {
            submenu.style.display = 'none';
        }
    });

    document.getElementById('profile-link').addEventListener('click', function () {
        document.getElementById('profile-form').classList.add('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('address-form').classList.remove('active');
        document.getElementById('voucher').classList.remove('active');
    });


    document.getElementById('orders-link').addEventListener('click', function () {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.add('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('address-form').classList.remove('active');
        document.getElementById('voucher').classList.remove('active');
    });

    // Gán sự kiện click cho tất cả các tab
    document.querySelectorAll('.tab-link').forEach(tab => {
        tab.addEventListener('click', function (event) {
            event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết
            let status = this.dataset.status; // Lấy giá trị trạng thái từ thuộc tính data-status
            status = status === "null" ? null : parseInt(status, 10); // Chuyển đổi giá trị về kiểu số nguyên hoặc null

            if (status === 6) {
                // Nếu là tab "Trả hàng/Hoàn tiền", gọi API get-doi-tra
                fetchDoiTra();
            } else {
                // Nếu là các tab khác, gọi API get-list-by-status
                fetchOrderData(status);
            }

            // Xóa class active từ các tab khác
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
            // Thêm class active vào tab hiện tại
            this.classList.add('active');
        });
    });

    // Hàm để lấy dữ liệu đơn hàng từ API
    async function fetchOrderData(status) {
        const token = localStorage.getItem('token'); // Lấy token từ localStorage
        const response = await fetch('/rest/hoadon/get-list-by-status', {
            method: 'POST', // Sử dụng phương thức POST
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // Thêm token vào header Authorization
            },
            body: JSON.stringify({status}) // Gửi đối tượng JSON với thuộc tính status
        });

        if (response.ok) {
            const result = await response.json();
            order = result.data;
            displayOrderData(result.data); // Hiển thị dữ liệu đơn hàng
        } else {
            console.error('Lỗi khi gọi API lấy dữ liệu đơn hàng.'); // Hiển thị lỗi nếu có
        }
    }

    // Hàm để lấy dữ liệu "Trả hàng/Hoàn tiền" từ API get-doi-tra
    async function fetchDoiTra() {
        const token = localStorage.getItem('token'); // Lấy token từ localStorage
        const response = await fetch('/yeu-cau/get-list', { // Sử dụng phương thức GET và endpoint mới
            method: 'GET', // Sử dụng phương thức GET
            headers: {
                'Authorization': `Bearer ${token}` // Thêm token vào header Authorization
            }
        });

        if (response.ok) {
            const result = await response.json();
            order = result.data;
            displayDoiTra(result.data); // Hiển thị dữ liệu "Trả hàng/Hoàn tiền"
        } else {
            console.error('Lỗi khi gọi API get-list.'); // Hiển thị lỗi nếu có
        }
    }

    // Map trạng thái trả hàng/hoàn tiền
    const trangThaiDoiTraMap = {
        0: 'Chờ xử lý',
        1: 'Đang xử lý',
        2: 'Hoàn thành',
        3: 'Từ chối'
    };

    // Hàm hiển thị dữ liệu trả hàng/hoàn tiền
    function displayDoiTra(orderList) {
        const orderContents = document.getElementById('order-contents');
        orderContents.innerHTML = ''; // Xóa nội dung trước đó

        if (orderList && orderList.length > 0) {
            orderList.forEach(order => {
                // Tạo container cho đơn hàng
                const orderContainer = document.createElement('div');
                orderContainer.classList.add('order-container'); // Thêm class để tạo kiểu cho toàn bộ đơn hàng

                // Tạo phần đầu đơn hàng
                const orderHeader = document.createElement('div');
                orderHeader.classList.add('order-header');
                orderHeader.innerHTML = `
                <h2>Mã đơn hàng: ${order.hoaDonModel.ma}</h2>
                <span class="status">${trangThaiDoiTraMap[order.hoaDonModel.trangThaiDoiTra] || 'Không xác định'}</span>
            `;
                orderContainer.appendChild(orderHeader);

                // Tạo chi tiết đơn hàng
                const orderDetails = document.createElement('div');
                orderDetails.classList.add('order-details');
                let totalRefund = 0;  // Khởi tạo tổng tiền hoàn lại

                // Thêm các sản phẩm trong đơn hàng
                order.hoaDonModel.hoaDonChiTietModels.forEach((hdct, index) => {
                    // Kiểm tra trangThaiDoiTra khác null
                    if (hdct.trangThaiDoiTra !== null) {
                        const orderItem = document.createElement('div');
                        orderItem.classList.add('order-item');

                        // Lấy số lượng từ yeuCauDoiTraChiTietModel tương ứng với sản phẩm
                        let soLuong = 0;
                        if (order.yeuCauDoiTraChiTietModel) {
                            // Tìm item trong yeuCauDoiTraChiTietModel dựa trên idSanPhamChiTiet
                            const item = order.yeuCauDoiTraChiTietModel.find(item => item.idSPCT === hdct.idSanPhamChiTiet);
                            if (item) {
                                soLuong = item.soLuong;  // Lấy số lượng từ yêu cầu đổi trả
                            }
                        }

                        // Tính số tiền hoàn lại cho sản phẩm
                        if (hdct.trangThaiDoiTra === 2) {
                            thanhTien = hdct.gia * soLuong;
                            totalRefund += thanhTien;  // Cộng vào tổng tiền hoàn lại
                        }

                        orderItem.innerHTML = `
                        <h3>
                            <img src="images/${hdct.sanPhamChiTietModel.sanPhamModel.anh}" alt="" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
                            ${hdct.sanPhamChiTietModel.sanPhamModel.ten}
                            <span class="status" style="float: right;">${trangThaiDoiTraMap[hdct.trangThaiDoiTra] || 'Không xác định'}</span>
                        </h3>
                        <div class="classification">
                            <p>Phân loại hàng: màu ${hdct.sanPhamChiTietModel.mauSac.ten}, size ${hdct.sanPhamChiTietModel.size.ten}</p>
                            <p class="price">${hdct.gia.toLocaleString('vi-VN')}₫</p>
                        </div>
                        <p>x${soLuong}</p>  <!-- Hiển thị số lượng từ yeuCauDoiTraChiTietModel -->
                    `;
                        orderDetails.appendChild(orderItem);

                        // Thêm dấu phân cách giữa các sản phẩm nếu không phải là sản phẩm cuối cùng
                        if (index < order.hoaDonModel.hoaDonChiTietModels.length - 1) {
                            const separator = document.createElement('hr');
                            orderDetails.appendChild(separator);
                        }
                    }
                });

                // Hiển thị tổng tiền hoàn lại cho đơn hàng
                const totalDiv = document.createElement('div');
                totalDiv.classList.add('order-total');
                // totalDiv.innerHTML = `<strong>Số tiền: ${totalRefund.toLocaleString('vi-VN')}₫</strong>`;  // Hiển thị tổng số tiền hoàn lại
                orderContainer.appendChild(orderDetails);
                orderContainer.appendChild(totalDiv);

                // Phần hành động (nếu có)
                const orderActions = document.createElement('div');
                orderActions.classList.add('order-actions');
                orderActions.innerHTML = '';
                orderContainer.appendChild(orderActions);

                // Thêm đơn hàng vào danh sách đơn hàng
                orderContents.appendChild(orderContainer);
            });
        } else {
            orderContents.innerHTML = '<p>Không có đơn hàng nào.</p>';
        }
    }


    // Định nghĩa các trạng thái và mô tả tương ứng
    const trangThaiMap = {
        0: 'CHỜ XÁC NHẬN',
        1: 'CHỜ THANH TOÁN',
        2: 'CHỜ GIAO HÀNG',
        3: 'VẬN CHUYỂN',
        4: 'HOÀN THÀNH',
        5: 'ĐÃ HỦY',
        6: 'ĐÃ HOÀN TIỀN'
    };

    // Hàm để hiển thị dữ liệu đơn hàng lên giao diện
    function displayOrderData(orderList) {
        const orderContents = document.getElementById('order-contents');
        orderContents.innerHTML = ''; // Clear previous content

        if (orderList && orderList.length > 0) {
            orderList.forEach(order => {
                // Create a container for the entire order
                const orderContainer = document.createElement('div');
                orderContainer.classList.add('order-container'); // Class for styling the whole order

                // Create order header
                const orderHeader = document.createElement('div');
                orderHeader.classList.add('order-header');
                orderHeader.innerHTML = `
                <h2>Mã đơn hàng: ${order.ma}</h2>
                <span class="status">${trangThaiMap[order.trangThai] || 'Không xác định'}</span>
            `;
                orderContainer.appendChild(orderHeader);

                // Create order details
                const orderDetails = document.createElement('div');
                orderDetails.classList.add('order-details');


                // Add order items
                order.hoaDonChiTietModels.forEach((hdct, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.classList.add('order-item');

                    const thanhTien = hdct.soLuong * hdct.gia;
                    orderItem.innerHTML = `
                    <h3>
                        <img src="images/${hdct.sanPhamChiTietModel.sanPhamModel.anh}" alt="" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
                        ${hdct.sanPhamChiTietModel.sanPhamModel.ten}
                    </h3>
                    <div class="classification">
                        <p>Phân loại hàng: màu ${hdct.sanPhamChiTietModel.mauSac.ten}, size ${hdct.sanPhamChiTietModel.size.ten}</p>
                        <p class="price">${hdct.gia.toLocaleString('vi-VN')}₫</p>
                    </div>
                    <p>x${hdct.soLuong}</p>
                `;
                    orderDetails.appendChild(orderItem);

                    if (index < order.hoaDonChiTietModels.length - 1) {
                        const separator = document.createElement('hr');
                        orderDetails.appendChild(separator);
                    }
                });

                const totalDiv = document.createElement('div');
                totalDiv.classList.add('order-total');
                totalDiv.innerHTML = `<strong>Tổng cộng: ${order.tongTien.toLocaleString('vi-VN')}₫</strong>`;
                orderContainer.appendChild(orderDetails);
                orderContainer.appendChild(totalDiv);

                const orderActions = document.createElement('div');
                orderActions.classList.add('order-actions');

                // Add action buttons based on order status
                orderActions.innerHTML = `
                ${order.trangThai === 4 || order.trangThai === 5 ?
                    `<button class="buy-again" onclick='buyAgain(${JSON.stringify(order)})'>Mua lại</button>` : ''}
               ${order.trangThai === 4 && isReturnAllowed(order.ngayGiaoHang) && order.trangThaiDoiTra !== 2 ?
                    `<button class="request-return" onclick='requestReturn(${JSON.stringify(order)})'>Yêu cầu đổi trả</button>` : ''}


               ${order.trangThai === 5 ?
                    `<button class="cancel-details" onclick="showCancelDetailsModal(${order.id})">Xem chi tiết hủy đơn</button>`
                    : ''}

               ${order.trangThai === 1 || order.trangThai === 0
                    ? `<button onclick="showCancelConfirmDialog(${order.id})" class="cancel-order" style="background-color: #ff5722; color: #fff;">Hủy đơn hàng</button>`
                    : ''}

                ${order.trangThai === 6 ? `<div class="refund"><span class="refund-label">Số tiền hoàn lại:</span> <span class="refund-amount">₫${order.tongTien}</span></div>` : ''}
            `;
                orderContainer.appendChild(orderActions); // Add the actions (buy again, cancel, etc.)

                // Add the entire order container to the orderContents
                orderContents.appendChild(orderContainer);
            });
        } else {
            orderContents.innerHTML = '<p>Không có đơn hàng nào.</p>'; // Display message if no orders
        }
    }

    // Hàm kiểm tra nếu yêu cầu đổi trả hợp lệ (trong vòng 15 ngày từ ngày đặt hàng)
    function isReturnAllowed(ngayGiaoHang) {
        const today = new Date();
        const giaoHangDate = new Date(ngayGiaoHang);
        const diffTime = today - giaoHangDate;
        const diffDays = diffTime / (1000 * 3600 * 24);
        return diffDays <= 15;
    }

    // Gọi dữ liệu đơn hàng khi tab "Tất cả" được kích hoạt lần đầu
    document.querySelector('.tab-link[data-status="null"]').classList.add('active');
    fetchOrderData(null);

    document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', function () {
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Hàm để gọi API lấy dữ liệu người dùng
    async function layDuLieuNguoiDung(token) {
        const response = await fetch('user/get', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            return data;
        } else {
            console.error('Lỗi khi lấy dữ liệu người dùng');
        }
    }

    // Hàm để hiển thị ảnh đại diện khi người dùng chọn tệp và kiểm tra tệp ảnh hợp lệ
    document.getElementById('profile-pic').addEventListener('change', function (event) {
        const file = event.target.files[0];

        if (file) {
            // Kiểm tra loại tệp (mimetype)
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'image/svg+xml'];

            // Nếu tệp không phải là ảnh, hiển thị thông báo lỗi
            if (!validImageTypes.includes(file.type)) {
                toastr.error('Vui lòng chọn một tệp ảnh hợp lệ (JPEG, PNG, GIF, BMP, WebP, SVG)', 'Lỗi');
                // Xóa tệp đã chọn để người dùng có thể chọn lại
                event.target.value = '';
                return;
            }

            // Nếu tệp là ảnh, sử dụng FileReader để hiển thị ảnh đại diện
            const reader = new FileReader();

            reader.onload = function (e) {
                document.getElementById('profile-pic-img').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });


    // Hàm để gán thông tin vào form hồ sơ cá nhân
    async function ganThongTinVaoForm() {
        const token = localStorage.getItem('token');
        if (token) {
            const duLieuNguoiDung = await layDuLieuNguoiDung(token);
            if (duLieuNguoiDung) {
                const profile = duLieuNguoiDung.data.profile;
                document.getElementById('username').value = duLieuNguoiDung.data.userName || '';
                document.getElementById('name').value = profile.hoVaTen || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('cccd').value = profile.cccd || '';
                document.getElementById('dob').value = profile.ngaySinh || '';
                const avatarImg = document.getElementById('profile-pic-img');
                if (profile.avatar) {
                    avatarImg.src = `${profile.avatar}`;
                    document.getElementById('user-avatar').src = profile.avatar;
                }
                document.getElementById('user-name').innerText = profile.hoVaTen;
                // Xử lý giới tính
                if (profile.gioiTinh === 'NAM') {
                    document.querySelector('input[name="gender"][value="NAM"]').checked = true;
                } else if (profile.gioiTinh === 'NU') {
                    document.querySelector('input[name="gender"][value="NU"]').checked = true;
                }
                const capBac = duLieuNguoiDung.data.capBac;
                const badgeElement = document.getElementById('user-badge');
                if (capBac === 'BAC') {
                    badgeElement.textContent = 'Bạc';
                    badgeElement.className = 'user-badge badge-silver';
                } else if (capBac === 'VANG') {
                    badgeElement.textContent = 'Vàng';
                    badgeElement.className = 'user-badge badge-gold';
                } else if (capBac === 'KIM_CUONG') {
                    badgeElement.textContent = 'Kim Cương';
                    badgeElement.className = 'user-badge badge-diamond';
                } else {
                    badgeElement.style.display = 'none'; // Ẩn huy hiệu nếu không có cấp bậc hợp lệ
                }

            }
        }
    }

    // Gọi hàm ganThongTinVaoForm khi trang được tải
    window.onload = ganThongTinVaoForm;


    // Hàm hiển thị thông báo
    function hienThiThongBao(message, success = true) {
        const notification = document.getElementById('notification');
        notification.innerText = message;
        notification.style.backgroundColor = success ? 'rgba(0, 128, 0, 0.8)' : 'rgba(255, 0, 0, 0.8)';
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Hàm để lấy giá trị từ form và tạo yêu cầu cập nhật
    function updateRequest() {
        return {
            hoVaTen: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            cccd: document.getElementById('cccd').value,
            gioiTinh: document.querySelector('input[name="gender"]:checked')?.value || null,
            ngaySinh: document.getElementById('dob').value
        };
    }

    async function updateProfile(request) {
        const token = localStorage.getItem('token');

        const formData = new FormData();

        formData.append('request', JSON.stringify(request));

        const fileInput = document.getElementById('profile-pic');
        const file = fileInput.files[0];
        if (file) {
            formData.append('file', file);
        }

        Swal.fire({
            title: 'Bạn có chắc chắn muốn cập nhật thông tin?',
            text: 'Các thay đổi sẽ được lưu lại!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy bỏ',
            reverseButtons: true
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch('profile/update', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        toastr.success('Cập nhật thành công!', 'Thành công');
                        ganThongTinVaoForm();
                    } else {
                        toastr.error('Có lỗi xảy ra khi cập nhật thông tin.', 'Lỗi');
                    }
                } catch (error) {
                    toastr.error('Đã xảy ra lỗi trong quá trình cập nhật.', 'Lỗi');
                }
            } else {
                toastr.info('Hủy bỏ cập nhật', 'Thông báo');
            }
        });
    }


    // Gán sự kiện click cho nút Cập Nhật
    document.getElementById('update-button').addEventListener('click', function (event) {
        event.preventDefault();
        const request = updateRequest();
        updateProfile(request);
    });

    // Gán sự kiện click cho liên kết "Đổi mật khẩu"
    document.getElementById('change-password-link').addEventListener('click', function () {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('password-form').classList.add('active');
        document.getElementById('address-form').classList.remove('active');
        document.getElementById('voucher').classList.remove('active');
    });

    // Hàm để gọi API đổi mật khẩu
    async function doiMatKhau(request) {
        const token = localStorage.getItem('token');
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(request)
        });
        if (response.ok) {
            toastr.success('Đổi mật khẩu thành công!', 'Thành công');
            // Clear the password form
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            // Chuyển trở lại form hồ sơ và áp dụng hiệu ứng hover
            document.getElementById('password-form').classList.remove('active');
            document.getElementById('profile-form').classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            document.getElementById('profile-link').classList.add('active');
        } else {
            toastr.error('Mật khẩu không chính xác!', 'Lỗi');
        }
    }

    function hienThiModalXacNhan(message, callback) {
        const modal = document.getElementById("confirm-dialog");
        const messageElement = document.getElementById("confirm-message");
        const btnYes = document.getElementById("confirm-yes");
        const btnNo = document.getElementById("confirm-no");

        // Cập nhật thông báo
        messageElement.textContent = message;

        // Hiển thị modal
        modal.style.display = "block";

        // Xử lý khi nhấn nút "Có"
        btnYes.onclick = function () {
            modal.style.display = "none"; // Ẩn modal
            callback(true); // Gọi callback với giá trị true
        };

        // Xử lý khi nhấn nút "Không"
        btnNo.onclick = function () {
            modal.style.display = "none"; // Ẩn modal
            callback(false); // Gọi callback với giá trị false
        };
    }

    // Sử dụng modal xác nhận trong nút đổi mật khẩu
    document.getElementById("change-password-button").addEventListener("click", function (event) {
        event.preventDefault();

        const oldPassword = document.getElementById("old-password").value.trim();
        const password = document.getElementById("new-password").value.trim();
        const retypePassword = document.getElementById("confirm-password").value.trim();

        // Kiểm tra các trường không được rỗng
        if (!oldPassword || !password || !retypePassword) {
            toastr.error('Vui lòng nhập đầy đủ thông tin!', 'Lỗi');
            return;
        }

        // Kiểm tra mật khẩu mới và xác nhận mật khẩu
        if (password !== retypePassword) {
            toastr.error('Mật khẩu mới và xác nhận mật khẩu không khớp!', 'Lỗi');
            return;
        }

        // Kiểm tra mật khẩu mới có hợp lệ
        const pattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*([0-9]|[^0-9dA-Za-z])).{8,100}$/;
        if (!pattern.test(password)) {
            toastr.error(
                'Mật khẩu phải từ 8 đến 100 ký tự, chứa ít nhất 1 chữ thường, 1 chữ hoa, và 1 ký tự đặc biệt hoặc số!', 'Lỗi'
            );
            return;
        }

        // Sử dụng SweetAlert2 để hiển thị modal xác nhận
        Swal.fire({
            title: 'Bạn có chắc chắn muốn đổi mật khẩu không?',
            text: "Hành động này không thể hoàn tác.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đổi mật khẩu',
            cancelButtonText: 'Hủy bỏ',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const request = {oldPassword, password, retypePassword};
                doiMatKhau(request); // Gọi API đổi mật khẩu
            }
        });
    });


    // Hàm để gọi API lấy danh sách địa chỉ
    async function layDanhSachDiaChi() {
        const token = localStorage.getItem('token');
        const response = await fetch('/dia-chi/get-list', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            return data.data; // Điều chỉnh theo cấu trúc phản hồi API của bạn
        } else {
            console.error('Lỗi khi lấy danh sách địa chỉ');
        }
    }

    // Hàm để hiển thị danh sách địa chỉ
    async function hienThiDanhSachDiaChi() {
        const diaChiList = await layDanhSachDiaChi();
        const addressListContainer = document.getElementById('address-list');
        addressListContainer.innerHTML = ''; // Xóa nội dung cũ

        if (diaChiList && diaChiList.length > 0) {
            diaChiList.forEach(diaChi => {
                const addressItem = document.createElement('div');
                addressItem.classList.add('address-item');
                const isDefault = diaChi.trangThai === 1;
                addressItem.innerHTML = `
                <div class="address-content">
                    <div class="address-info">
                        <h4>${diaChi.hoTen} | ${diaChi.sdt} ${isDefault ? '<span class="default">Mặc định</span>' : ''}</h4>
                        <p>${diaChi.diaChi}</p>
                        <p>${diaChi.thanhPho}, ${diaChi.quocGia}</p>
                    </div>
                    <div class="address-actions">
                        <button class="edit-address-btn" onclick="chinhSuaDiaChi(${diaChi.id})">Chỉnh sửa</button>
                        <button class="delete-address-btn" onclick="hienThiXacNhanHanhDong(${diaChi.id}, 'delete')">Xóa</button>
                        <button class="default-address-btn" style="${isDefault ? 'display: none;' : ''}" onclick="hienThiXacNhanHanhDong(${diaChi.id}, 'default')">Thiết lập mặc định</button>
                    </div>
                </div>
            `;
                addressListContainer.appendChild(addressItem);
            });
        } else {
            addressListContainer.innerHTML = '<p>Không có địa chỉ nào.</p>';
        }
    }


    // Gọi hàm hiển thị danh sách địa chỉ khi form "Địa chỉ" được kích hoạt
    document.getElementById('address-link').addEventListener('click', function () {
        document.getElementById('voucher').classList.remove('active');
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('address-form').classList.add('active');
        hienThiDanhSachDiaChi();
    });

    // Gán sự kiện click cho nút "Thêm địa chỉ mới"
    document.getElementById('add-address-button').addEventListener('click', function () {
        document.getElementById('address-list').style.display = 'none'; // Ẩn danh sách địa chỉ
        document.getElementById('add-address-form').style.display = 'block'; // Hiển thị form thêm mới
    });

    // Đảm bảo rằng DOM đã tải xong trước khi gán sự kiện
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-address-button').addEventListener('click', function () {
            document.getElementById('address-list').style.display = 'none'; // Ẩn danh sách địa chỉ
            document.getElementById('add-address-form').style.display = 'block'; // Hiển thị form thêm mới
            document.getElementById('form-title').innerText = 'Thêm mới địa chỉ';
            document.getElementById('save-button').onclick = submitNewAddress;
            isEditing = false; // Đặt lại trạng thái
        });

        document.getElementById('confirm-yes').addEventListener('click', xacNhanHanhDong);
        document.getElementById('confirm-no').addEventListener('click', function () {
            document.getElementById('confirm-dialog').style.display = 'none';
            diaChiIdToHandle = null; // Reset biến lưu trữ ID
            confirmAction = null; // Reset biến lưu trữ hành động
        });
    });


    // Hàm để xóa địa chỉ
    async function xoaDiaChi() {
        if (diaChiIdToHandle !== null) {
            const response = await fetch(`/dia-chi/${diaChiIdToHandle}`, {
                method: 'DELETE'
            });

            if (response.code === '200') {
                toastr.success('Địa chỉ đã được xóa thành công!', 'Thành công');
                hienThiDanhSachDiaChi();
            } else {
                const errorData = await response.json();
                const errorMessage = errorData.message || 'Lỗi khi xóa địa chỉ, vui lòng kiểm tra lại!';

                toastr.error(errorMessage, 'Lỗi');
            }

            diaChiIdToHandle = null; // Reset biến lưu trữ ID
        }
    }


    // Hàm để thiết lập địa chỉ mặc định
    async function thietLapMacDinh() {
        if (diaChiIdToHandle !== null) {
            const response = await fetch(`/dia-chi/change/${diaChiIdToHandle}`, {
                method: 'PUT'
            });
            if (response.ok) {
                toastr.success('Địa chỉ đã được thiết lập mặc định!', 'Thành công');
                hienThiDanhSachDiaChi(); // Cập nhật lại danh sách địa chỉ sau khi thay đổi mặc định thành công
            } else {
                console.error('Lỗi khi thiết lập địa chỉ mặc định');
                toastr.error('Lỗi khi thiết lập địa chỉ mặc định, vui lòng kiểm tra lại!', 'Lỗi');
            }
            diaChiIdToHandle = null; // Reset biến lưu trữ ID
        }
    }

    // Hàm để hiển thị thông báo xác nhận dùng chung với Swal
    function hienThiXacNhanHanhDong(id, action) {
        diaChiIdToHandle = id;
        confirmAction = action;

        let message = 'Bạn có chắc chắn muốn thực hiện hành động này không?';
        let title = 'Xác nhận hành động';

        if (action === 'default') {
            message = 'Bạn có chắc chắn muốn thiết lập địa chỉ này làm mặc định không?';
            title = 'Thiết lập mặc định';
        } else if (action === 'delete') {
            message = 'Bạn có chắc chắn muốn xóa địa chỉ này không?';
            title = 'Xóa địa chỉ';
        }

        // Sử dụng SweetAlert để hiển thị hộp thoại xác nhận
        Swal.fire({
            title: title,
            text: message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy',
        }).then((result) => {
            if (result.isConfirmed) {
                // Gọi hành động tùy theo loại
                if (confirmAction === 'default') {
                    thietLapMacDinh();
                } else if (confirmAction === 'delete') {
                    xoaDiaChi();
                }
            }
        });
    }

    // Hàm xử lý các hành động xác nhận
    function xacNhanHanhDong() {
        if (confirmAction === 'default') {
            thietLapMacDinh();
        } else if (confirmAction === 'delete') {
            xoaDiaChi();
        }
    }


    // Gán sự kiện cho các nút xác nhận
    document.getElementById('confirm-yes').addEventListener('click', xacNhanHanhDong);
    document.getElementById('confirm-no').addEventListener('click', function () {
        document.getElementById('confirm-dialog').style.display = 'none';
        diaChiIdToHandle = null; // Reset biến lưu trữ ID
        confirmAction = null; // Reset biến lưu trữ hành động
    });

    // document.getElementById('add-new-address-btn').addEventListener('click', function () {
    //     document.getElementById('address-list').style.display = 'none'; // Ẩn danh sách địa chỉ
    //     document.getElementById('add-address-form').style.display = 'block'; // Hiển thị form thêm mới
    // });


    // Hàm để hủy thêm mới địa chỉ
    function cancelNewAddress() {
        document.getElementById('add-address-form').style.display = 'none'; // Ẩn form thêm mới
        document.getElementById('add-address-button').style.display = 'block';
        document.getElementById('address-list').style.display = 'block'; // Hiển thị lại danh sách địa chỉ
        clearFormErrors(); // Xóa tất cả lỗi
        document.getElementById('hoTen').value = '';
        document.getElementById('diaChi').value = '';
        document.getElementById('sdt').value = '';
        document.getElementById('thanhPho').value = '';
        document.getElementById('quocGia').value = '';
    }

    // Hàm để xóa tất cả lỗi khi hủy
    function clearFormErrors() {
        const errorElements = document.querySelectorAll('.error-message');
        errorElements.forEach(el => el.remove());
    }

    // Hàm xử lý khi gửi form thêm mới địa chỉ
    async function submitNewAddress() {
        // Xóa tất cả lỗi trước khi kiểm tra mới
        clearFormErrors();

        // Lấy giá trị từ các input
        const hoTen = document.getElementById('hoTen').value.trim();
        const diaChi = document.getElementById('diaChi').value.trim();
        const sdt = document.getElementById('sdt').value.trim();
        const thanhPho = document.getElementById('thanhPho').value.trim();
        const quocGia = document.getElementById('quocGia').value.trim();

        let valid = true;

        // Kiểm tra hợp lệ
        if (!hoTen || hoTen.length > 100) {
            toastr.error('Họ tên không được để trống và không vượt quá 100 ký tự.', 'Lỗi');
            valid = false;
        }
        if (!sdt || sdt.length < 10 || sdt.length > 15) {
            toastr.error('Số điện thoại phải có từ 10 đến 15 ký tự.', 'Lỗi');
            valid = false;
        }
        if (!diaChi) {
            toastr.error('Địa chỉ không được để trống.', 'Lỗi');
            valid = false;
        }
        if (!thanhPho) {
            toastr.error('Thành phố không được để trống.', 'Lỗi');
            valid = false;
        }
        if (!quocGia) {
            toastr.error('Quốc gia không được để trống.', 'Lỗi');
            valid = false;
        }

        if (!valid) return;

        const newAddress = {
            hoTen,
            diaChi,
            sdt,
            thanhPho,
            quocGia
        };

        // Sử dụng SweetAlert để xác nhận trước khi gọi API
        const result = await Swal.fire({
            title: 'Bạn có chắc chắn muốn lưu địa chỉ này?',
            text: 'Bạn sẽ không thể thay đổi thông tin sau khi đã lưu!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Lưu',
            cancelButtonText: 'Hủy',
        });

        // Nếu người dùng chọn xác nhận (confirm)
        if (result.isConfirmed) {
            // Gọi API tương ứng dựa trên trạng thái (thêm mới hoặc chỉnh sửa)
            let response;
            if (isEditing) {
                response = await fetch(`/dia-chi/${diaChiIdToHandle}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(newAddress)
                });
            } else {
                response = await fetch('/dia-chi/insert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(newAddress)
                });
            }

            // Xử lý phản hồi từ API
            if (response.ok) {
                toastr.success(isEditing ? 'Địa chỉ đã được cập nhật thành công!' : 'Địa chỉ mới đã được thêm thành công!', 'Thành công');
                // Xóa các giá trị đã nhập trong form sau khi thêm thành công
                document.getElementById('hoTen').value = '';
                document.getElementById('diaChi').value = '';
                document.getElementById('sdt').value = '';
                document.getElementById('thanhPho').value = '';
                document.getElementById('quocGia').value = '';
                cancelNewAddress(); // Ẩn form và hiển thị lại danh sách địa chỉ
                hienThiDanhSachDiaChi(); // Cập nhật lại danh sách địa chỉ
            } else {
                console.error('Lỗi khi thêm hoặc cập nhật địa chỉ');
                const errorData = await response.json();
                toastr.error(`Lỗi: ${errorData.message}`, 'Lỗi');
            }
        } else {
            toastr.info('Hành động bị hủy', 'Thông báo');
        }
    }


    async function chinhSuaDiaChi(id) {
        // Hiển thị form trước khi gọi API lấy thông tin địa chỉ
        document.getElementById('address-list').style.display = 'none'; // Ẩn danh sách địa chỉ
        document.getElementById('add-address-form').style.display = 'block'; // Hiển thị form thêm mới
        document.getElementById('form-title').innerText = 'Chỉnh sửa địa chỉ';
        document.getElementById('save-button').onclick = submitNewAddress;
        document.getElementById('add-address-button').style.display = 'none';
        isEditing = true;
        diaChiIdToHandle = id;

        const response = await fetch(`/dia-chi/${id}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            const diaChi = data.data;
            document.getElementById('hoTen').value = diaChi.hoTen;
            document.getElementById('diaChi').value = diaChi.diaChi;
            document.getElementById('sdt').value = diaChi.sdt;
            document.getElementById('thanhPho').value = diaChi.thanhPho;
            document.getElementById('quocGia').value = diaChi.quocGia;
        } else {
            console.error('Lỗi khi lấy thông tin địa chỉ');
        }
    }


    // Hàm để hiển thị thông báo lỗi dưới input
    function showError(inputId, message) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.style.color = 'red';
        errorElement.textContent = message;
        inputElement.parentNode.appendChild(errorElement);
    }

    // Function to show the confirmation dialog
    function showCancelConfirmDialog(orderId) {
        document.getElementById('confirm-cancel').style.display = 'block';
        document.getElementById('confirm-cancel-yes').onclick = function () {
            const orderInfo = getSelectedCancelReason();
            if (orderInfo) {
                cancelOrder(orderId, orderInfo);
            } else {
                toastr.error('Vui lòng chọn lý do hủy!', 'Lỗi');
            }
        };
        document.getElementById('confirm-cancel-no').onclick = function () {
            document.getElementById('confirm-cancel').style.display = 'none';
            resetCancelReasonSelection();
        };
    }

    function resetCancelReasonSelection() {
        const cancelReasonRadios = document.getElementsByName('cancel-reason');
        for (let i = 0; i < cancelReasonRadios.length; i++) {
            cancelReasonRadios[i].checked = false;
        }
    }

    function getSelectedCancelReason() {
        const cancelReasonRadios = document.getElementsByName('cancel-reason');
        for (let i = 0; i < cancelReasonRadios.length; i++) {
            if (cancelReasonRadios[i].checked) {
                return cancelReasonRadios[i].value;
            }
        }
        return null;
    }


    // Function to call the cancel order API
    async function cancelOrder(orderId, orderInfo) {
        const token = localStorage.getItem('token');
        const response = await fetch(`/rest/hoadon/cancel/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({orderInfo})
        });

        if (response.ok) {
            const result = await response.json();
            toastr.success('Đơn hàng đã được hủy thành công!', 'Thành công');
            document.getElementById('confirm-cancel').style.display = 'none'; // Ẩn modal
            resetCancelReasonSelection();
            fetchOrderDataForActiveTab(); // Refresh the order list for the active tab
        } else {
            toastr.error('Có lỗi xảy ra khi hủy đơn hàng.', 'Lỗi');
        }
    }

    // Function to fetch order data for the currently active tab
    function fetchOrderDataForActiveTab() {
        const activeTab = document.querySelector('.tab-link.active');
        if (activeTab) {
            let status = activeTab.dataset.status;
            status = status === "null" ? null : parseInt(status, 10);
            fetchOrderData(status);
        }
    }

    // Hàm để hiển thị chi tiết hủy đơn trong modal
    function showCancelDetailsModal(orderId) {
        fetch(`rest/hoadon/get/${orderId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`  // Gửi token nếu cần
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === "200") {
                    const cancelDetailsContent = document.getElementById('cancel-details-content');
                    const orderDetails = data.data; // Dữ liệu trả về từ API

                    let contentHTML = '';
                    contentHTML = `
                    <div id="order-code">
                        <h3>Mã đơn hàng: ${orderDetails.ma}</h3>
                    </div>
` + contentHTML;
                    // Lặp qua các chi tiết sản phẩm và tạo HTML
                    orderDetails.hoaDonChiTietModels.forEach(item => {
                        contentHTML += `
                    <div class="product-detail">
                        <img src="images/${item.sanPhamChiTietModel.sanPhamModel.anh}" alt="${item.sanPhamChiTietModel.sanPhamModel.ten}" />
                        <div class="product-info">
                            <h4>${item.sanPhamChiTietModel.sanPhamModel.ten}</h4>
                            <p>Size: ${item.sanPhamChiTietModel.size.ten}</p>
                            <p>Màu sắc: ${item.sanPhamChiTietModel.mauSac.ten}</p>
                            <p>Số lượng: ${item.soLuong}</p>
                            <p class="price">Giá: ₫${item.gia}</p>
                        </div>
                    </div>
                `;
                    });

                    // Add reason for cancellation section
                    contentHTML += `
                    <div id="cancel-reason">
                        <h5>Lý do hủy đơn:</h5>
                        <p>${orderDetails.lyDoHuy || 'Chưa có lý do'}</p>
                    </div>
                `;

                    // Cập nhật nội dung chi tiết vào modal
                    cancelDetailsContent.innerHTML = contentHTML;

                    // Hiển thị modal
                    document.getElementById('cancel-detail-modal').style.display = 'block';
                } else {
                    toastr.error('Không tìm thấy thông tin chi tiết!', 'Lỗi');
                }
            })
            .catch(error => {
                console.error('Error fetching cancel details:', error);
                toastr.error('Có lỗi xảy ra khi tải thông tin chi tiết!', 'Lỗi');
            });
    }

    // Hàm để đóng modal
    function closeCancelModal() {
        // Ẩn modal khi nhấn nút "Đóng"
        document.getElementById('cancel-detail-modal').style.display = 'none';
    }

    function buyAgain(order) {
        const token = localStorage.getItem('token');

        if (!token) {
            toastr.error('Bạn cần đăng nhập để thực hiện hành động này.', 'Lỗi');
            return;
        }

        if (typeof order === 'string') {
            order = JSON.parse(order);
        }

        showConfirmDialog(order);
    }

    function showConfirmDialog(order) {
        Swal.fire({
            title: 'Bạn có chắc chắn muốn mua lại các sản phẩm này?',
            text: 'Các sản phẩm sẽ được thêm vào giỏ hàng của bạn.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                processBuyAgain(order); // Gọi hàm mua lại sản phẩm
            }
        });
    }

    function processBuyAgain(order) {
        // Lấy các chi tiết sản phẩm từ đơn hàng
        const products = order.hoaDonChiTietModels.map(item => ({
            idSanPham: item.sanPhamChiTietModel.idSanPham,
            idSize: item.sanPhamChiTietModel.size.id,
            idMauSac: item.sanPhamChiTietModel.mauSac.id,
            soLuong: item.soLuong
        }));

        const requests = products.map(product => {
            const requestBody = {
                idSanPham: product.idSanPham,
                idSize: product.idSize,
                idMauSac: product.idMauSac,
                soLuong: product.soLuong
            };

            return fetch('/gio-hang-chi-tiet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}` // Gửi token trong header Authorization
                },
                body: JSON.stringify(requestBody)
            });
        });

        Promise.all(requests)
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(data => {
                const allSuccess = data.every(item => item.code === '200');

                if (allSuccess) {
                    toastr.success('Sản phẩm đã được thêm vào giỏ hàng.', 'Thành công');
                    setTimeout(function () {
                        location.href = '/cart'; // Chuyển hướng đến trang giỏ hàng
                    }, 1000);
                } else {
                    toastr.error('Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng.', 'Lỗi');
                }
            })
            .catch(error => {
                toastr.error('Có lỗi xảy ra khi gọi API.', 'Lỗi');
            });
    }

    document.getElementById('voucher-link').addEventListener('click', function () {
        document.getElementById('profile-form').classList.remove('active');
        document.getElementById('orders-tabs').classList.remove('active');
        document.getElementById('password-form').classList.remove('active');
        document.getElementById('address-form').classList.remove('active');
        document.getElementById('voucher').classList.add('active'); // Corrected ID
        fetchVoucherList();
    });

    async function fetchVoucherList() {
        const voucherListContainer = document.getElementById('voucher-list');
        voucherListContainer.innerHTML = '<p>Loading vouchers...</p>'; // Display loading message

        const token = localStorage.getItem('token');
        const response = await fetch('khuyen-mai/get-list-by-user', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const result = await response.json();
            displayVoucherList(result.data);
        } else {
            console.error('Error fetching voucher list');
            voucherListContainer.innerHTML = '<p>Error loading vouchers.</p>'; // Display error message
        }
    }

    function displayVoucherList(vouchers) {
        const voucherListContainer = document.getElementById('voucher-list');
        voucherListContainer.innerHTML = ''; // Clear previous content

        if (vouchers && vouchers.length > 0) {
            vouchers.forEach(voucher => {
                const voucherItem = document.createElement('div');
                voucherItem.classList.add('voucher-item');

                // Định dạng ngày tháng
                const expiryDate = new Date(voucher.ngayKetThuc);
                const formattedDate = expiryDate.toLocaleDateString('vi-VN');  // Định dạng ngày theo kiểu Việt Nam

                // Hiển thị voucher với thông tin từ API
                voucherItem.innerHTML = `
                <h3>Mã Voucher: ${voucher.ma || 'N/A'}</h3>
                <p>Mô tả: ${voucher.moTa || 'Không có mô tả'}</p>
                <p>Giá trị: ${voucher.giaTri ? voucher.giaTri.toLocaleString('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }) : 'Chưa có giá trị'}</p>
                <p>Ngày hết hạn: ${formattedDate}</p>
            `;
                voucherListContainer.appendChild(voucherItem);
            });
        } else {
            voucherListContainer.innerHTML = '<p>Không có voucher nào.</p>';
        }
    }

    // Xử lý yêu cầu đổi trả


    let idSanPhamChiTiets = [];  // Mảng lưu trữ id của các sản phẩm được chọn

    function requestReturn(order) {
        console.log(order.trangThaiDoiTra);

        if (order.trangThaiDoiTra === 0 || order.trangThaiDoiTra === 1) {
            toastr.error('Bạn đã gửi 1 yêu cầu trước đó rồi!', 'Lỗi');
            return;
        }

        // Hiển thị modal
        orderId = order.id;
        const modal = document.getElementById("request-return-modal");
        modal.classList.add("show"); // Thêm lớp "show" để kích hoạt hiệu ứng mở

        // Cập nhật danh sách sản phẩm trong modal
        const productList = document.getElementById("product-list");
        productList.innerHTML = '';  // Xóa danh sách sản phẩm cũ

        // Tạo một container cho tất cả các ô sản phẩm
        const container = document.createElement('div');
        container.classList.add('product-container');

        // Hiển thị danh sách sản phẩm
        order.hoaDonChiTietModels.forEach(item => {
            const productItem = document.createElement('div');
            productItem.classList.add('product-item');
            productItem.setAttribute('id', `product-${item.idSanPhamChiTiet}`); // Thêm ID cho mỗi sản phẩm để dễ dàng thao tác

            // Lấy size và màu rồi chuyển sang chữ thường
            const size = item.sanPhamChiTietModel.size.ten.toLowerCase();
            const color = item.sanPhamChiTietModel.mauSac.ten.toLowerCase();
            const formattedPrice = item.gia.toLocaleString('vi-VN');

            // Tạo các phần tử cộng trừ số lượng
            const quantityControl = document.createElement('div');
            quantityControl.classList.add('quantity-control');

            const decrementButton = document.createElement('button');
            decrementButton.innerText = '-';
            decrementButton.addEventListener('click', () => updateQuantity(item.idSanPhamChiTiet, -1, item.soLuong));

            const quantityDisplay = document.createElement('input');
            quantityDisplay.type = 'number';
            quantityDisplay.value = 1;
            quantityDisplay.min = 1;
            quantityDisplay.step = 1;
            quantityDisplay.max = item.soLuong;  // Số lượng tối đa không được vượt quá số lượng đã mua
            quantityDisplay.addEventListener('blur', () => {
                if (parseInt(quantityDisplay.value) < 1) {
                    quantityDisplay.value = 1;
                } else if (parseInt(quantityDisplay.value) > item.soLuong) {
                    quantityDisplay.value = item.soLuong;
                }
            });
            quantityDisplay.addEventListener('change', () => updateQuantity(item.idSanPhamChiTiet, parseInt(quantityDisplay.value) - parseInt(quantityDisplay.defaultValue), item.soLuong));

            const incrementButton = document.createElement('button');
            incrementButton.innerText = '+';
            incrementButton.addEventListener('click', () => updateQuantity(item.idSanPhamChiTiet, 1, item.soLuong));

            quantityControl.appendChild(decrementButton);
            quantityControl.appendChild(quantityDisplay);
            quantityControl.appendChild(incrementButton);

            // Thêm thông tin vào ô sản phẩm
            productItem.innerHTML = `
        <div class="product-image">
            <img src="images/${item.sanPhamChiTietModel.sanPhamModel.anh}" alt="${item.sanPhamChiTietModel.sanPhamModel.ten}">
        </div>
        <div class="product-info">
            <p>${item.sanPhamChiTietModel.sanPhamModel.ten} - Size: ${size}, Màu: ${color}</p>
            <p><strong>Số lượng đã mua:</strong> x${item.soLuong}</p>
            <span style="margin-left: auto; font-weight: bold; color: orangered">${formattedPrice} VND</span>
        </div>
        `;

            // Thêm phần điều khiển số lượng vào sản phẩm
            productItem.appendChild(quantityControl);

            // Thêm sự kiện chọn sản phẩm
            productItem.addEventListener('click', () => toggleSelection(item.idSanPhamChiTiet, productItem));

            container.appendChild(productItem);
        });

        // Thêm tất cả các ô sản phẩm vào product-list
        productList.appendChild(container);
    }

    // Cập nhật số lượng sản phẩm muốn đổi
    function updateQuantity(productId, change, maxQuantity) {
        event.preventDefault();
        const quantityInput = document.querySelector(`#product-${productId} .quantity-control input`);
        let currentQuantity = parseInt(quantityInput.value);
        let newQuantity = currentQuantity + change;

        // Đảm bảo số lượng không nhỏ hơn 1 và không vượt quá số lượng đã mua
        if (newQuantity >= 1 && newQuantity <= maxQuantity) {
            quantityInput.value = newQuantity;
        } else if (newQuantity < 1) {
            // Nếu số lượng nhỏ hơn 1, đặt lại về 1
            quantityInput.value = 1;
        } else if (newQuantity > maxQuantity) {
            // Nếu số lượng vượt quá số lượng đã mua, đặt lại về maxQuantity
            quantityInput.value = maxQuantity;
        }
    }

    // Hàm toggleSelection sẽ được gọi mỗi khi một ô sản phẩm được chọn
    function toggleSelection(productId, productItem) {
        // Kiểm tra xem sản phẩm có được chọn không
        const isSelected = productItem.classList.contains('selected');

        if (isSelected) {
            // Nếu sản phẩm đã được chọn, xóa khỏi mảng và thay đổi lại màu nền
            const index = idSanPhamChiTiets.indexOf(productId);
            if (index > -1) {
                idSanPhamChiTiets.splice(index, 1);
            }
            productItem.classList.remove('selected');
            productItem.style.backgroundColor = '#f9f9f9'; // Màu nền mặc định
        } else {
            // Nếu sản phẩm chưa được chọn, thêm vào mảng và thay đổi màu nền
            idSanPhamChiTiets.push(productId);
            productItem.classList.add('selected');
            productItem.style.backgroundColor = '#d3d3d3'; // Màu nền xám khi sản phẩm được chọn
        }

        // In ra mảng idSanPhamChiTiets để kiểm tra
        console.log('idSanPhamChiTiets',idSanPhamChiTiets);
    }


    // Đóng modal
    function closeRequestReturnModal() {
        const modal = document.getElementById("request-return-modal");
        modal.classList.remove("show"); // Loại bỏ lớp "show" khi đóng modal
        const form = document.getElementById('request-return-form');
        form.reset();
        const filePreview = document.getElementById('file-preview');
        filePreview.innerHTML = '';
    }

    // Hàm ẩn modal khi bấm ngoài modal
    window.onclick = function (event) {
        const modal = document.getElementById("request-return-modal");
        if (event.target === modal) {
            closeRequestReturnModal();
        }
    };

    // Mảng chứa các tệp đã chọn
    let selectedFiles = [];

    // Lắng nghe sự kiện thay đổi tệp
    document.getElementById('files').addEventListener('change', function (event) {
        const files = event.target.files;
        const previewContainer = document.getElementById('file-preview');
        previewContainer.innerHTML = ''; // Xóa nội dung cũ trước khi thêm preview mới

        // Thêm các tệp mới vào mảng
        selectedFiles = Array.from(files);

        // Duyệt qua các tệp đã chọn và tạo preview
        selectedFiles.forEach((file, index) => {
            const fileType = file.type.split('/')[0]; // Lấy loại tệp (image, video)

            const previewItem = document.createElement('div');
            previewItem.classList.add('preview-item');

            // Tạo phần tử đóng dấu X
            const closeBtn = document.createElement('span');
            closeBtn.textContent = 'X';  // Dấu X
            closeBtn.classList.add('close-btn');

            // Xử lý sự kiện click để xóa ảnh/video khỏi preview và khỏi mảng selectedFiles
            closeBtn.addEventListener('click', function () {
                // Xóa tệp khỏi mảng
                selectedFiles.splice(index, 1);

                // Cập nhật lại input files
                updateInputFiles();

                // Xóa phần tử preview
                previewContainer.removeChild(previewItem);
            });

            // Thêm nút "X" vào previewItem
            previewItem.appendChild(closeBtn);

            if (fileType === 'image') {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);  // Tạo URL tạm thời cho hình ảnh
                img.alt = file.name;
                previewItem.appendChild(img);
            } else if (fileType === 'video') {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);  // Tạo URL tạm thời cho video
                video.controls = true;  // Cho phép điều khiển video (play, pause)
                previewItem.appendChild(video);
            }

            // Thêm tên tệp vào preview
            const fileName = document.createElement('p');
            fileName.textContent = file.name;
            previewItem.appendChild(fileName);

            // Thêm phần tử preview vào container
            previewContainer.appendChild(previewItem);
        });
    });

    // Hàm cập nhật lại input files từ mảng selectedFiles
    function updateInputFiles() {
        // Tạo đối tượng FileList mới từ mảng selectedFiles
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => {
            dataTransfer.items.add(file);
        });

        // Cập nhật lại thuộc tính input files
        document.getElementById('files').files = dataTransfer.files;
    }


    function submitReturnRequest() {
        // Lấy thông tin từ modal
        const selectedProducts = [];  // Mảng các đối tượng sản phẩm chi tiết (bao gồm ID và số lượng)

        // Duyệt qua tất cả các sản phẩm trong modal để lấy thông tin ID và số lượng
        document.querySelectorAll('.product-item.selected').forEach(item => {
            const productId = item.getAttribute('id').split('-')[1]; // Lấy ID sản phẩm từ ID của item
            const quantity = parseInt(item.querySelector('.quantity-control input').value);  // Lấy số lượng từ input của từng sản phẩm

            // Nếu số lượng hợp lệ và khác 0, thêm vào mảng selectedProducts
            if (quantity > 0) {
                selectedProducts.push({
                    idSanPhamChiTiet: productId,
                    soLuong: quantity
                });
            }
        });

        const loai = document.getElementById('type').value;  // Lấy loại yêu cầu (Đổi hàng / Trả hàng)
        const reason = document.getElementById('reason').value;  // Lý do yêu cầu
        const note = document.getElementById('note').value;  // Ghi chú thêm
        const bankInfo = document.getElementById('bank-info').value;  // Thông tin chuyển khoản
        const productExchangeInfo = document.getElementById('product-exchange').value;  // Thông tin mặt hàng muốn đổi
        const files = document.getElementById('files').files;  // Các tệp đã chọn
        console.log('selectedProducts', selectedProducts);
        // Kiểm tra các điều kiện bắt buộc
        if (selectedProducts.length === 0) {
            toastr.error('Bạn phải chọn ít nhất một sản phẩm để gửi yêu cầu.', 'Lỗi');
            return;
        }

        if (!loai) {
            toastr.error('Bạn phải chọn loại yêu cầu (Đổi hàng / Trả hàng).', 'Lỗi');
            return;
        }

        if (!reason) {
            toastr.error('Bạn phải nhập lý do yêu cầu.', 'Lỗi');
            return;
        }

        if (loai === 'DOI_HANG') {
            // Nếu là Đổi hàng, kiểm tra thông tin mặt hàng muốn đổi
            if (!productExchangeInfo) {
                toastr.error('Bạn phải nhập thông tin mặt hàng muốn đổi.', 'Lỗi');
                return;
            }
        } else if (loai === 'TRA_HANG') {
            // Nếu là Trả hàng, kiểm tra thông tin chuyển khoản
            if (!bankInfo) {
                toastr.error('Bạn phải nhập thông tin chuyển khoản.', 'Lỗi');
                return;
            }
        }
        if (files.length === 0) {
            toastr.error('Bạn phải chọn ít nhất một tệp để gửi yêu cầu.', 'Lỗi');
            return;
        }


        const requestData = {
            idHoaDon: orderId,
            sanPhamChiTiets: selectedProducts,
            loai: loai,
            lyDo: reason,
            ghiChu: note,
            thongTinChuyenKhoan: bankInfo,
            thongTinMatHangMuonDoi: productExchangeInfo
        };

        const token = localStorage.getItem('token');

        if (!token) {
            toastr.error('Bạn cần đăng nhập lại.', 'Lỗi');
            return;
        }

        const formData = new FormData();
        formData.append('request', JSON.stringify(requestData));  // Thêm requestData vào FormData

        // Thêm các file vào FormData
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);  // Thêm từng tệp vào FormData
        }

        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: "Bạn sẽ không thể thay đổi yêu cầu sau khi gửi.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4CAF50',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Có, gửi yêu cầu!',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/yeu-cau/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === "200") {
                            toastr.success(data.message, 'Thành công');
                            resetReturnRequestForm();
                            closeRequestReturnModal();
                        } else {
                            const errorMessage = data?.message || 'Đã có lỗi xảy ra';
                            toastr.error(errorMessage, 'Lỗi');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        toastr.error('Có lỗi xảy ra khi gửi yêu cầu.', 'Lỗi');
                    });
            } else {
                toastr.info('Bạn đã hủy yêu cầu.', 'Thông báo');
            }
        });
    }

    // Hàm reset cả form yêu cầu đổi trả
    function resetReturnRequestForm() {
        document.getElementById('type').value = '';  // Reset loại yêu cầu
        document.getElementById('reason').value = '';  // Reset lý do
        document.getElementById('note').value = '';  // Reset ghi chú
        idSanPhamChiTiets = [];

        resetFileSelection();
    }

    // Hàm reset các tệp và preview
    function resetFileSelection() {
        selectedFiles = [];

        // Cập nhật lại input files
        updateInputFiles();

        // Xóa toàn bộ phần preview
        const previewContainer = document.getElementById('file-preview');
        previewContainer.innerHTML = '';
    }

    function toggleFields() {
        var type = document.getElementById("type").value;

        // Ẩn hoặc hiển thị các trường tương ứng
        if (type === "DOI_HANG") {
            document.getElementById("product-exchange-info").style.display = "block";  // Hiển thị thông tin mặt hàng muốn đổi
            document.getElementById("bank-info-section").style.display = "none";  // Ẩn thông tin chuyển khoản
        } else if (type === "TRA_HANG") {
            document.getElementById("product-exchange-info").style.display = "none";  // Ẩn thông tin mặt hàng muốn đổi
            document.getElementById("bank-info-section").style.display = "block";  // Hiển thị thông tin chuyển khoản
        }
    }

    // Gọi hàm để set trạng thái ban đầu khi modal được mở
    toggleFields();

    function checkToken() {
        const token = localStorage.getItem('token');

        if (!token) {
            Swal.fire({
                icon: 'warning',
                title: 'Bạn chưa đăng nhập!',
                text: 'Vui lòng đăng nhập để tiếp tục.',
                confirmButtonText: 'Đến trang đăng nhập',
                willClose: () => {
                    window.location.href = '/v1/auth/login';
                }
            });
        } else {
            try {
                const decodedToken = jwt_decode(token);
                console.log(decodedToken);
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Token không hợp lệ',
                    text: 'Vui lòng đăng nhập lại.',
                    confirmButtonText: 'Đến trang đăng nhập',
                    willClose: () => {
                        window.location.href = '/v1/auth/login';
                    }
                });
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        checkToken();
    });
</script>
</body>
</html>
